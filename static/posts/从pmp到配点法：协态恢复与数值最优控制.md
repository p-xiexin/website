---
description: 解释说明射击法与配点法的优劣以及实际应用
date: '2025-08-15'
author: 'pxx'
categories:
  - Optimal Control
published: true
column:
  name: 最优控制
---



# 从 PMP 到配点法：协态消失之后，结构是否仍然存在？

> **配点法**本质上是在时间网格上直接优化一串离散的轨迹点  
> $(x_k,u_k)$，通过离散动力学约束将这些点拼接成一条可行轨迹；  
> **射击法**则不是逐点求解轨迹，而是求解一组能够生成整条最优轨迹的参数  
> （如协态初值与拉格朗日乘子），轨迹由哈密顿系统前向积分自动生成。
>
> **配点法解的是“点”，射击法解的是“参数”。**

在前两篇文章中，我们已经完成了最优控制理论中最核心的一次抽象跃迁：从拉格朗日力学的变分结构出发，引入协态变量，将带微分约束的优化问题转化为哈密顿系统，并通过庞特里亚金最大值原理（PMP）给出了最优性的必要条件。

从理论上看，这一步已经"解决"了最优控制问题——至少在结构层面如此。然而，正是在这里，理论与计算之间出现了一道无法回避的鸿沟。

## 1. PMP 的真实形态：一个高度不适合直接计算的问题

考虑如下标准最优控制问题：

$$
\min_{u(\cdot)}\;
J = \int_{t_0}^{t_f} L(x(t),u(t),t)\,\mathrm dt + \Phi(x(t_f))
$$

在系统动力学约束下，求最优控制 $u^*(\cdot)$。
$$
\dot x(t)=f(x(t),u(t),t), \qquad x(t_0)=x_0
$$
引入哈密顿函数
$$
\mathcal H(x,u,\lambda,t)
= L(x,u,t) + \lambda^\top f(x,u,t),
$$
庞特里亚金最大值原理给出如下必要条件：
$$
\begin{cases}
\dot x(t)=\dfrac{\partial \mathcal H}{\partial \lambda}(x,u,\lambda,t),\\[6pt]
\dot\lambda(t)=-\dfrac{\partial \mathcal H}{\partial x}(x,u,\lambda,t),\\[6pt]
u^*(t)=\arg\max_u \mathcal H(x,u,\lambda,t),
\end{cases}
$$



并配合混合边界条件：
$$
x(t_0)=x_0,\qquad
\lambda(t_f)=\nabla_x\Phi(x(t_f))\ \ (终端状态自由).
$$

若考虑终端状态约束
$$
\psi(x(t_f))=0
$$
则允许的变分满足
$$
\nabla\psi(x(t_f))\,\delta x(t_f)=0
$$

由终端边界项
$$
\bigl[\lambda(t_f)-\nabla_x\Phi(x(t_f))\bigr]^\top \delta x(t_f)=0
$$
可得
$$
\boxed{
\lambda(t_f)
=
\nabla_x\Phi(x(t_f))
+
\nabla\psi(x(t_f))^\top \mu
}
$$

其中 $\mu$ 为拉格朗日乘子。

> 直接处理 $x(t_f)\in\mathcal M$ 是一个**可行性问题**；  
> 转化为  
> \[
> \lambda(t_f)-\nabla\Phi(x(t_f)) \;\perp\; T_{x(t_f)}\mathcal M
> \]
> 则把它变成了一个**一阶最优性条件**。“在所有允许的终端方向上，目标函数的一阶变化为零。”

从分析的角度看，这一组 PMP 条件构成了一个定义在相空间上的**非线性哈密顿系统两点边值问题**（TPBVP）：状态变量在初始时刻给定，而与之对偶的协态变量却在终端时刻给定。这种混合边界条件使问题在本质上不同于常见的初值问题，任何试图沿时间单向推进的数值积分方法，在逻辑上都不再直接适用。

从动力系统的角度进一步审视，可以发现问题的困难并非仅来自边界条件的"分裂"，而是源于哈密顿系统本身的稳定性结构。协态方程是状态方程的伴随系统，其时间演化方向与状态相反；在绝大多数最优控制问题中，这一伴随系统在正向时间上是指数不稳定的。这意味着，即使协态初值存在唯一正确解，任意微小的初值误差也会在积分过程中被迅速放大，从而导致数值轨迹完全偏离真实解。

此外，最优控制问题往往并非光滑问题。控制变量通常通过极值条件隐式定义，一旦引入控制约束或路径约束，最优控制可能呈现开关结构或分段定义的形式，相应地，哈密顿系统的右端项不再满足经典常微分方程所要求的光滑性条件。这种非光滑性并非数值误差所致，而是最优性结构本身的直接体现。

更深一层来看，庞特里亚金最大值原理本身并未试图给出一种构造性算法。它回答的是"若某条轨迹是最优的，则它必须满足什么条件"，而不是"如何从给定初值出发稳健地找到这条轨迹"。在这一意义上，PMP 与欧拉–拉格朗日方程在解析力学中的角色是完全一致的：它们揭示结构，却并不直接承诺可计算性。

因此，PMP 给出的并不是一个可以直接数值积分的模型，而是一种关于最优解所必须满足的**结构性描述**。正是这一点，决定了在数值层面上必须对问题的表达方式进行重新组织，而不是简单地"实现"这些方程。

## 2. 射击法：忠实于 PMP，但暴露了哈密顿系统的脆弱性

 如果说庞特里亚金最大值原理给出了最优控制问题在连续时间下的结构性描述，那么射击法几乎是任何试图将这一描述转化为具体计算的人，都会自然走到的第一步。它并非源于某种数值技巧的选择，而是源于对 PMP 形式本身的直接理解。

射击法的核心思想是引入参数化：设协态初值为

$$
\lambda(t_0)=\lambda_0\in\mathbb{R}^n,
$$

其中 $\lambda_0$ 是待定参数。给定 $\lambda_0$ 后，可以将 PMP 的正则方程视为初值问题：

$$
\begin{cases}
\dot z(t)=\mathcal{F}(z(t),t),\\[6pt]
z(t_0)=(x_0,\lambda_0)^\top,
\end{cases}
$$

其中 $z=(x,\lambda)^\top\in\mathbb{R}^{2n}$，向量场 $\mathcal{F}$ 由哈密顿系统定义。

对该初值问题进行积分（如使用 Runge–Kutta 方法），可得终端状态与协态：

$$
z(t_f)=\Psi(t_f;t_0,z_0)=\Psi(t_f;t_0,(x_0,\lambda_0)^\top).
$$

记终端协态为

$$
\lambda(t_f;\lambda_0)=\operatorname{proj}_\lambda\!\left(\Psi(t_f;t_0,(x_0,\lambda_0)^\top)\right),
$$

其中 $\operatorname{proj}_\lambda$ 表示对 $\lambda$ 分量的投影。射击法的目标函数定义为

$$
\mathcal{G}(\lambda_0):=\lambda(t_f;\lambda_0)-\nabla_x\Phi(x(t_f;\lambda_0)),
$$

求解根方程：

$$
\mathcal{G}(\lambda_0)=0.
$$

这是一个 $n$ 维非线性方程组，通常使用 Newton 法或拟 Newton 法求解：

$$
\lambda_0^{(k+1)}=\lambda_0^{(k)}-\left[\nabla_{\lambda_0}\mathcal{G}(\lambda_0^{(k)})\right]^{-1}\mathcal{G}(\lambda_0^{(k)}).
$$

射击法的核心困难来自哈密顿系统的稳定性结构。考虑协态方程的线性化：

$$
\delta\dot\lambda=-\left(\frac{\partial^2\mathcal{H}}{\partial x^2}+\frac{\partial^2\mathcal{H}}{\partial x\partial\lambda}\frac{\partial^2\mathcal{H}}{\partial\lambda\partial x}\right)\delta\lambda=:-A(t)\delta\lambda.
$$

对于典型的最优控制问题，矩阵 $A(t)$ 的特征值往往具有正实部，这意味着协态方程在正向时间上是指数不稳定的。具体而言，若 $A$ 的最大特征值为 $\sigma_{\max}>0$，则协态扰动的增长率满足：

$$
|\delta\lambda(t)|\le|\delta\lambda(t_0)|\,e^{\sigma_{\max}(t-t_0)}.
$$

对于长时间区间或强非线性问题，即使初值误差 $\|\delta\lambda(t_0)\|$ 极小（如机器精度 $10^{-16}$），在 $t=t_f$ 时也可能被放大至 $\mathcal{O}(1)$。

更严重的是，在数值积分过程中，每一步都会引入截断误差 $\epsilon_{\text{trunc}}\sim\mathcal{O}(\Delta t^{p+1})$（$p$ 为方法阶数）和舍入误差 $\epsilon_{\text{round}}\sim\mathcal{O}(\epsilon_{\text{mach}})$。这些误差在伴随系统中累积并放大：

$$
\text{total error}\sim\epsilon_{\text{trunc}}\cdot e^{\sigma_{\max}T}+\epsilon_{\text{round}}\cdot e^{\sigma_{\max}T},
$$

其中 $T=t_f-t_0$。这使得射击法的数值稳定性极度依赖于问题的时间跨度和系统的非线性强度。

从优化几何的角度看，射击法面对的是一个**高维参数空间中的低维约束流形搜索问题**。雅可比矩阵

$$
J(\lambda_0)=\nabla_{\lambda_0}\mathcal{G}(\lambda_0)=\frac{\partial\lambda(t_f)}{\partial\lambda_0}-\nabla^2_{x}\Phi(x(t_f))\frac{\partial x(t_f)}{\partial\lambda_0}
$$

的条件数可以估计为：

$$
\kappa(J)\sim e^{(\sigma_{\max}-\sigma_{\min})T},
$$

其中 $\sigma_{\min}<0$ 是状态方程稳定方向的李雅普诺夫指数。对于 $T$ 较大的问题，$\kappa(J)$ 可轻易超过 $10^{10}$，使得 Newton 迭代完全失效。

此外，当系统维数 $n$ 增加时，搜索空间维数为 $n$，而终端条件定义的流形维数保持不变（通常为 $n$）。这种“针孔命中”的几何结构，使得数值搜索在高维空间中几乎必然失败。即便采用多重射击等改进策略，引入中间节点以缓解数值不稳定性，其根本几何结构并未发生改变。

进一步地，一旦最优控制问题中引入状态约束或控制约束，射击法的局限性会更加突出。最优控制律往往不再是光滑函数，而是呈现开关或分段定义的形式，这直接破坏了射击法所依赖的连续可导假设，使得根求解过程在数值上难以稳定进行。在实际问题中，这通常意味着大量人工调参与问题特定处理，其鲁棒性与可重复性都难以保证。

## 3. 配点法的思想转向：从"解微分方程"到"直接离散问题"

射击法的局限性并非源于某种实现技巧的不成熟，而是连续时间 PMP 表达方式在数值层面的必然结果。一旦这一点被充分认识，最优控制的数值求解便不可避免地走向一种更为根本的思想转向：不再执着于沿时间方向求解状态–协态微分方程，而是从一开始就将问题视为一个整体优化问题。

### 3.1 时间离散化与函数空间的有限维投影

配点法的第一步是对时间区间 $[t_0,t_f]$ 进行离散。引入节点集合

$$
\mathcal{T}_N = \{t_0,t_1,\ldots,t_N=t_f\},\quad t_k = t_0 + k\Delta t,
$$

其中 $\Delta t = (t_f-t_0)/N$。在更一般的自适应网格中，节点间距可以不均匀。

在函数空间 $C^1([t_0,t_f];\mathbb{R}^n)$ 中选择一组基函数 $\{\phi_k(t)\}_{k=0}^N$，状态和控制被近似为：

$$
x(t) \approx x_N(t) := \sum_{k=0}^N x_k\phi_k(t),\quad x_k\in\mathbb{R}^n,
$$

$$
u(t) \approx u_N(t) := \sum_{k=0}^N u_k\psi_k(t),\quad u_k\in\mathbb{R}^m.
$$

常用的基函数包括：

- Lagrange 插值基：$\phi_k(t) = \prod_{j\neq k}\frac{t-t_j}{t_k-t_j}$，满足 $\phi_k(t_j)=\delta_{kj}$
- B-样条基：具有紧支撑和高阶光滑性
- Legendre 多项式基：用于谱配点法，具有最佳逼近性质

这一步本质上是将无穷维优化问题

$$
\min_{x(\cdot)\in C^1,\,u(\cdot)\in L^\infty} J[x,u]
$$

投影到有限维子空间 $\operatorname{span}\{\phi_k\}\times\operatorname{span}\{\psi_k\}$ 上：

$$
\min_{x_k,u_k\in\mathbb{R}} J_N[\{x_k\},\{u_k\}].
$$

### 3.2 动力学约束的代数化

在连续时间中，系统动力学表达为微分方程：

$$
\dot x(t) = f(x(t),u(t),t),\quad \forall t\in[t_0,t_f].
$$

配点法将这一无穷维约束转化为有限个配点处的代数约束。给定基函数 $\{\phi_k\}$，状态导数为

$$
\dot x_N(t) = \sum_{k=0}^N x_k\dot\phi_k(t).
$$

在配点节点 $\{t_i\}_{i=1}^N$ 处，要求动力学精确满足：

$$
\sum_{k=0}^N x_k\dot\phi_k(t_i) = f\left(\sum_{k=0}^N x_k\phi_k(t_i),\,\sum_{k=0}^N u_k\psi_k(t_i),\,t_i\right),\quad i=1,\ldots,N.
$$

利用配点性质 $\phi_k(t_i)=\delta_{ki}$，上式简化为：

$$
\sum_{k=0}^N D_{ik}x_k = f(x_i,u_i,t_i),\quad i=1,\ldots,N,
$$

其中**微分矩阵**定义为：

$$
D_{ik} := \dot\phi_k(t_i) = 
\begin{cases}
\displaystyle\sum_{j\neq k}\frac{1}{t_k-t_j}\prod_{\ell\neq k,j}\frac{t_i-t_\ell}{t_k-t_\ell}, & k\neq i,\\[12pt]
\displaystyle\sum_{j\neq i}\frac{1}{t_i-t_j}, & k=i.
\end{cases}
$$

对于等距节点和 Lagrange 基，$D$ 可以显式计算。对于 Legendre–Gauss–Lobatto (LGL) 配点，$D$ 具有特殊的谱性质。

用矩阵形式表达，记

$$
X = [x_0,x_1,\ldots,x_N]^\top\in\mathbb{R}^{(N+1)\times n},\quad
U = [u_0,u_1,\ldots,u_N]^\top\in\mathbb{R}^{(N+1)\times m},
$$

动力学约束可写为：

$$
DX = F(X,U),
$$

其中 $F(X,U)=[f(x_0,u_0,t_0),\ldots,f(x_N,u_N,t_N)]^\top$。

### 3.3 目标泛函的数值积分

连续时间的目标泛函

$$
J = \Phi(x(t_f)) + \int_{t_0}^{t_f} L(x(t),u(t),t)\,\mathrm{d}t
$$

通过数值积分公式离散化。常用的方法包括：

- **梯形法则**：

  $$
  J_N = \Phi(x_N) + \frac{\Delta t}{2}\left[L(x_0,u_0,t_0) + 2\sum_{k=1}^{N-1}L(x_k,u_k,t_k) + L(x_N,u_N,t_N)\right].
  $$

- **Simpson 法则**：

  $$
  J_N = \Phi(x_N) + \frac{\Delta t}{3}\sum_{k=0}^{N/2-1}\left[L_{2k} + 4L_{2k+1} + L_{2k+2}\right],
  $$

  其中 $L_k = L(x_k,u_k,t_k)$。

- **Gauss 积分**：对于谱配点法，使用 Gauss 权重 $\{w_k\}$：

  $$
  J_N = \Phi(x_N) + \sum_{k=0}^N w_k L(x_k,u_k,t_k),\quad \sum_{k=0}^N w_k = t_f-t_0.
  $$

  对于 LGL 配点，权重由 Legendre 多项式的性质给出：

  $$
  w_k = \frac{2}{N(N+1)[P_N(t_k)]^2},
  $$

  其中 $P_N$ 是 $N$ 阶 Legendre 多项式。

### 3.4 完整的非线性规划问题

综合上述离散化，配点法将原始最优控制问题转化为：

$$
\boxed{
\begin{aligned}
\min_{X,U}\quad & J_N(X,U) = \Phi(x_N) + \sum_{k=0}^N w_k L(x_k,u_k,t_k)\\
\text{s.t.}\quad & DX - F(X,U) = 0,\\
& x_0 = x_0^{\text{given}},\\
& g(X,U) \leq 0\quad \text{(路径约束)},\\
& h(x_N) = 0\quad \text{(终端约束)}.
\end{aligned}
}
$$

这是一个标准的**非线性规划问题 (NLP)**，决策变量为

$$
z = (X,U) \in \mathbb{R}^{(N+1)(n+m)},
$$

约束个数为 $Nn$（动力学）$+n$（初值）$+\cdots$。

相比连续时间 PMP 的无穷维两点边值问题，离散 NLP 具有以下优势：

- **有限维优化**：可以使用成熟的 NLP 求解器（IPOPT、SNOPT、KNITRO）
- **全局约束耦合**：所有节点同时优化，避免时间方向的误差累积
- **自然处理约束**：状态约束、控制约束可直接添加为代数不等式
- **稀疏结构**：雅可比矩阵和 Hessian 矩阵具有带状稀疏结构，可高效存储和分解

### 3.5 配点法的几何意义

从几何角度看，配点法实施了一个**正交投影**：

$$
\pi:\,C^1([t_0,t_f];\mathbb{R}^n)\longrightarrow \mathcal{P}_N := \operatorname{span}\{\phi_0,\ldots,\phi_N\},
$$

其中 $\mathcal{P}_N$ 是 $N$ 次多项式空间。最优解 $(x^*,u^*)$ 被近似为其在 $\mathcal{P}_N$ 上的投影：

$$
x_N^* = \arg\min_{x_N\in\mathcal{P}_N} \|x^* - x_N\|_{H^1},
$$

在适当的 Sobolev 范数下。对于高阶谱配点，$\mathcal{P}_N$ 的逼近能力随 $N$ 指数增长，从而保证了离散解的快速收敛。

这一投影过程并未改变问题的优化本质，只是改变了问题的表达域。关键的观察是：在 $\mathcal{P}_N$ 上，动力学约束从微分算子变为代数约束，优化问题从泛函极值变为有限维极值，但最优性条件的结构——特别是对偶变量的角色——得到了完整保留。

正是这种结构保留，使得配点法虽然“隐藏”了协态，却并未丢失 PMP 的本质。

## 4. 配点法的本质：在函数空间中一次性冻结整个轨迹

通过在时间区间上选取节点并引入多项式近似，配点法将原始最优控制问题转化为一个大规模非线性规划问题（NLP）。在这一过程中，最显著的现象是：协态变量不再显式出现。

让我们更清晰地写出这一转化的形式结构。原始最优控制问题可以被表述为：

$$
\min_{x(\cdot),u(\cdot)} \Phi(x(t_f)) + \int_{t_0}^{t_f} L(x,u,t)\,\mathrm{d}t
$$

受约束于

$$
\dot x(t) = f(x(t),u(t),t),\quad x(t_0)=x_0.
$$

而经过配点法的离散化处理，这一问题被转化为：

$$
\min_{\{x_k,u_k\}_{k=0}^N} \Phi(x_N) + \sum_{k=0}^{N-1} w_k L(x_k,u_k,t_k)
$$

受约束于

$$
\sum_{j=0}^N D_{kj} x_j = f(x_k,u_k,t_k),\quad k=1,\ldots,N,
$$

$$
x_0 = x_0^{\text{given}}.
$$

在这一表述中，$D_{kj}$ 是由所选多项式基函数诱导的微分矩阵，$w_k$ 是数值积分权重。关键的观察是：**整个问题已经完全被表达为一个有限维优化问题，其中只有状态和控制作为决策变量，而协态变量完全不见踪影。**

这一现象常被误解为"配点法绕过了 PMP"，或者"配点法与变分原理无关"。然而，这种理解是表面的。更准确的说法应当是：**配点法将原本在连续时间层面通过协态变量表达的最优性结构，转化为在离散层面通过约束对偶变量隐式表达的最优性结构。**

从泛函分析的角度来看，配点法所做的实际上是一次**有限维投影**。原始问题定义在无穷维函数空间 $C^1([t_0,t_f])$ 上，而配点法将解的搜索范围限制在由多项式基张成的有限维子空间中。这一投影过程本身并不改变问题的优化本质，它只是改变了问题的表达域。

更进一步，配点法的核心思想可以被理解为：**不再试图在时间方向上逐步构造轨迹，而是在整个时间区间上同时确定所有节点的状态和控制值**。这种"同时确定"的策略，使得问题从动力系统的演化问题，转化为函数空间中的静态优化问题。在这一意义上，配点法所"冻结"的并不是时间本身，而是对时间演化的显式依赖。

这种思想转向带来的最直接好处是数值稳定性的提升。在射击法中，协态初值的微小误差会沿时间方向被指数放大；而在配点法中，所有节点的状态和控制同时作为优化变量出现，它们之间通过代数约束相互耦合，误差不再具有累积放大的机制。从优化理论的角度看，这相当于将一个不稳定的动态系统转化为一个条件良好的静态系统。

然而，协态的消失真的意味着变分结构的消失吗？这正是接下来需要深入探讨的问题。

## 5. 协态真的消失了吗？——问题的关键转折

协态在配点法中并未被抛弃，而是以一种更为隐蔽的方式被嵌入到了最优性条件之中。理解这一点的关键，在于将注意力从连续时间的哈密顿系统，转向离散优化问题的 **KKT 条件**。

回顾配点法所得到的 NLP 问题：

$$
\min_{\{x_k,u_k\}} \Phi(x_N) + \sum_{k=0}^{N-1} w_k L(x_k,u_k,t_k)
$$

受约束于

$$
g_k(x,u) := \sum_{j=0}^N D_{kj} x_j - f(x_k,u_k,t_k) = 0,\quad k=1,\ldots,N.
$$

这是一个标准的等式约束优化问题。根据拉格朗日对偶理论，引入拉格朗日乘子 $\{\mu_k\}_{k=1}^N$，构造拉格朗日函数：

$$
\mathcal{L}(x,u,\mu) = \Phi(x_N) + \sum_{k=0}^{N-1} w_k L(x_k,u_k,t_k) + \sum_{k=1}^N \mu_k^\top g_k(x,u).
$$

在最优解处，必须满足 KKT 一阶必要条件：

$$
\begin{cases}
\dfrac{\partial \mathcal{L}}{\partial x_k} = 0,\quad k=0,\ldots,N,\\[6pt]
\dfrac{\partial \mathcal{L}}{\partial u_k} = 0,\quad k=0,\ldots,N,\\[6pt]
g_k(x,u) = 0,\quad k=1,\ldots,N.
\end{cases}
$$

现在，让我们仔细展开第一个条件。对于 $k=1,\ldots,N-1$，有

$$
\frac{\partial \mathcal{L}}{\partial x_k} = w_k \frac{\partial L}{\partial x}(x_k,u_k,t_k) + \sum_{j=1}^N \mu_j^\top \left(D_{jk} I - \delta_{jk}\frac{\partial f}{\partial x}(x_k,u_k,t_k)\right) = 0.
$$

这里 $\delta_{jk}$ 是 Kronecker 符号。整理后可以写成：

$$
w_k \frac{\partial L}{\partial x}(x_k,u_k,t_k) + \sum_{j=1}^N D_{jk} \mu_j - \mu_k^\top \frac{\partial f}{\partial x}(x_k,u_k,t_k) = 0.
$$

这一等式的形式已经开始显露出某种熟悉的结构。如果我们定义

$$
\lambda_k := -\mu_k,
$$

并注意到微分矩阵的转置性质，上式可以被重新写为一种**离散伴随方程**的形式。

关键的洞察在于：**拉格朗日乘子 $\mu_k$ 并非任意的对偶变量，而是离散动力学约束的共轭变量。在连续极限下，它们正是协态变量的离散对应。**

为了更清楚地看到这一点，我们考虑最简单的情形：使用显式欧拉格式进行离散。此时动力学约束为

$$
\frac{x_{k+1}-x_k}{\Delta t} = f(x_k,u_k),
$$

对应的拉格朗日函数项为

$$
\mu_k^\top \left(\frac{x_{k+1}-x_k}{\Delta t} - f(x_k,u_k)\right).
$$

对 $x_k$ 求偏导数，得到

$$
-\frac{\mu_k}{\Delta t} - \mu_{k-1}^\top \frac{1}{\Delta t} - \mu_k^\top \frac{\partial f}{\partial x}(x_k,u_k) + w_k \frac{\partial L}{\partial x}(x_k,u_k) = 0.
$$

整理后，令 $\lambda_k = -\mu_k$，有

$$
\frac{\lambda_{k+1}-\lambda_k}{\Delta t} = -\frac{\partial L}{\partial x}(x_k,u_k) - \lambda_k^\top \frac{\partial f}{\partial x}(x_k,u_k).
$$

这正是协态方程的离散形式！

$$
\dot\lambda = -\frac{\partial H}{\partial x}
$$

因此，配点法中的拉格朗日乘子并非外来的对偶变量，而是协态变量在离散层面的自然显现。它们满足的方程，正是 PMP 中协态方程的离散版本。

更进一步，对控制变量的 KKT 条件给出

$$
\frac{\partial \mathcal{L}}{\partial u_k} = w_k \frac{\partial L}{\partial u}(x_k,u_k) - \mu_k^\top \frac{\partial f}{\partial u}(x_k,u_k) = 0,
$$

即

$$
\frac{\partial L}{\partial u}(x_k,u_k) + \lambda_k^\top \frac{\partial f}{\partial u}(x_k,u_k) = 0,
$$

这正是哈密顿函数对控制的临界条件

$$
\frac{\partial H}{\partial u} = 0.
$$

至此，一个事实已经清晰浮现：**配点法的 KKT 条件，在结构上与 PMP 的必要条件完全对应。状态方程、协态方程以及控制的极值条件，全部以离散形式被隐式满足。**

因此，协态从未消失。它只是从连续时间层面的显式变量，转化为离散优化问题中的对偶变量。配点法并未"绕过" PMP，而是在离散层面**隐式地执行**了 PMP。

## 6. 协态恢复：KKT 乘子即离散协态

既然配点法的 KKT 乘子对应于离散协态，那么一个自然的问题是：在数值求解配点法所得到的 NLP 之后，能否从 KKT 乘子中显式地恢复出协态轨迹？

答案是肯定的。几乎所有现代 NLP 求解器（如 IPOPT、SNOPT）在给出最优解的同时，都会自动返回所有等式和不等式约束对应的拉格朗日乘子。对于配点法而言，这些乘子中与动力学约束对应的部分，正是我们所需要的离散协态。

具体而言，设 NLP 求解器返回的动力学约束对应的拉格朗日乘子为 $\{\mu_k^*\}_{k=1}^N$，则离散协态可以直接定义为

$$
\lambda_k^* = -\mu_k^*,\quad k=1,\ldots,N.
$$

这一简单的符号翻转，背后体现的是连续时间伴随方程与离散约束对偶之间的对应关系。

更进一步，如果使用高阶配点方法（如 Legendre-Gauss-Lobatto 配点），则可以利用多项式插值，从节点处的离散协态值 $\{\lambda_k^*\}$ 恢复出整个时间区间上的连续协态函数：

$$
\lambda(t) \approx \sum_{k=0}^N \lambda_k^* \phi_k(t),
$$

其中 $\phi_k(t)$ 是用于状态插值的同一组基函数。

需要强调的是，这一恢复过程并非事后的"近似重构"，而是配点法内在结构的直接体现。在高阶谱配点方法中，由于多项式基函数具有极高的逼近精度，恢复出的协态轨迹在谱意义下可以达到指数收敛速度，即误差随节点数的增加呈指数衰减。

从实用角度来看，协态恢复的意义不仅在于理论上的完整性，更在于它为最优控制问题的验证提供了一条清晰的路径。通过检验恢复出的协态是否满足伴随方程、边界条件以及横截条件，可以从结构层面判断数值解的质量。在许多工程应用中，协态轨迹本身还具有直接的物理意义——例如，在航天器轨道优化问题中，协态对应于速度增量的影子价格，在经济最优控制问题中，协态对应于状态变量的边际价值。

因此，配点法并非抛弃了协态，而是将其以对偶变量的形式隐藏在 NLP 的 KKT 条件中。一旦 NLP 被求解，协态可以从拉格朗日乘子中直接恢复，且在高阶方法下具有与状态同等的精度。

## 7. 一个核心结论：协态完成了角色转变

至此，我们已经完整地看到了协态在从连续时间到离散时间、从变分法到优化理论之间的角色演变。这一演变并非偶然，而是反映了最优控制问题在不同数学框架下的深层统一性。

在连续时间框架下，协态源自**变分法**。它是拉格朗日泛函对状态导数的偏导数，是哈密顿力学中与位置共轭的广义动量在最优控制理论中的对应物。协态的引入，使得带微分约束的泛函极值问题可以被转化为哈密顿系统的两点边值问题。在这一层面，协态的意义在于：**它是使得变分问题可以被表达为正则方程的关键变量**。

在离散时间框架下，协态源自**优化理论**。它是拉格朗日函数对动力学约束的拉格朗日乘子，是有限维约束优化问题的对偶变量。协态的出现，是 KKT 一阶必要条件的自然结果。在这一层面，协态的意义在于：**它是动力学约束对目标函数影响的边际价格**。

这两种解释看似源自不同的数学体系，但在本质上是完全一致的。这种一致性可以从以下几个层面来理解：

**几何层面**：无论是在连续时间还是离散时间，协态都对应于余切丛上的坐标。在辛几何的框架下,状态与协态构成正则共轭对，它们之间的演化由哈密顿向量场所决定。配点法的离散化过程，可以被严格地理解为辛结构在有限维子空间上的投影。

**泛函层面**：在连续时间，协态满足伴随方程；在离散时间，协态满足离散伴随方程。两者都可以被理解为"目标泛函关于动力学扰动的梯度"。这一解释在最优控制的灵敏度分析中尤为清晰：协态的值恰好给出了终端代价对初始状态的敏感度。

**对偶层面**：在连续时间，协态通过哈密顿函数将状态与控制联系起来；在离散时间，协态通过拉格朗日函数将决策变量与约束联系起来。两者都体现了"主问题"与"对偶问题"之间的对应关系。在凸优化的框架下，这种对应关系可以通过 Fenchel 对偶或 Legendre 变换来严格刻画。

因此，协态在配点法中所完成的，不是简单的"消失"或"恢复"，而是一次**角色转变**：

- 从**显式的主变量**转变为**隐式的对偶变量**
- 从**微分方程的解**转变为**代数方程的乘子**
- 从**连续时间的伴随函数**转变为**离散节点的影子价格**

这一转变的根本原因在于：配点法改变了问题的表达域，但并未改变问题的优化本质。最优控制问题的内在结构——状态演化、代价积累、最优性条件——在离散层面得到了完整的保留，只是以不同的数学语言被重新表述。

从这一视角出发，我们可以对"配点法是否使用了 PMP"这一问题给出更为精确的回答：**配点法并非"使用"或"不使用" PMP，而是在离散层面隐式地满足了 PMP 的必要条件**。它通过优化理论的 KKT 条件，重现了变分法的庞特里亚金原理，只是表达形式从连续微分方程变为了离散代数方程。

## 9. 射击法与配点法的对比

经过前面的分析，我们现在可以更清晰地回答一个常见的问题：射击法与配点法的根本差异究竟在哪里？

表面上看，两者的区别在于实现方式：射击法显式地积分状态–协态方程，而配点法将问题转化为 NLP。然而，这种表述只是现象层面的描述，并未触及问题的本质。

更深层次的分歧在于：**两种方法对待 PMP 的态度不同**。

### 9.1 射击法：在连续层面显式执行 PMP

射击法的逻辑是：既然 PMP 给出了最优性的必要条件，那么就应当直接求解这些条件所定义的微分方程组。在这一框架下：

- 协态是**显式的主变量**，需要在整个时间区间上被积分
- 状态–协态方程是**必须被精确满足的动力学约束**
- 问题的求解归结为寻找合适的协态初值，使得终端条件得到满足

射击法对 PMP 的执行是**直接的、连续的、局部的**。它试图沿着时间方向逐步推进，在每一个瞬间都严格满足哈密顿正则方程。这种方法在概念上简洁，且忠实于 PMP 的原始形式。

然而，正如我们在第 2 节中讨论的,这种直接执行方式继承了哈密顿系统的全部数值困难：不稳定性、高维搜索、非光滑性。射击法的失败，并非因为它误解了 PMP，而是因为它过于忠实地遵循了 PMP 的连续形式。

### 9.2 配点法：在离散层面隐式满足 PMP

配点法的逻辑是：既然直接求解连续 PMP 在数值上不可行，那么就应当改变问题的表达方式，将其转化为一个更易于求解的形式。在这一框架下：

- 协态是**隐式的对偶变量**，通过 KKT 乘子间接体现
- 状态–协态方程被转化为**有限维的代数约束**
- 问题的求解归结为在整个时间区间上同时确定所有节点的状态和控制

配点法对 PMP 的执行是**间接的、离散的、全局的**。它不再沿时间方向推进，而是在整个时间区间上一次性求解。动力学约束不再需要在每一个瞬间被积分，而只需要在配点节点处被代数地满足。

关键的洞察在于：**配点法并未放弃 PMP，而是通过离散化将 PMP 的连续必要条件转化为离散必要条件，并通过求解离散优化问题隐式地满足这些条件**。从这一视角看，配点法与射击法并非对立的，而是同一数学结构在不同层面的体现。

### 9.3 本质差异的概括

我们可以将两者的差异概括为以下几点：

| 维度              | 射击法                 | 配点法                       |
| ----------------- | ---------------------- | ---------------------------- |
| **执行层面**      | 连续时间               | 离散时间                     |
| **协态角色**      | 显式主变量             | 隐式对偶变量                 |
| **求解方式**      | 时间方向推进           | 空间上同时优化               |
| **数值稳定性**    | 受哈密顿流不稳定性影响 | 通过全局约束耦合避免误差累积 |
| **对 PMP 的态度** | 直接求解连续必要条件   | 隐式满足离散必要条件         |
| **适用场景**      | 低维、光滑、无约束问题 | 高维、非光滑、带约束问题     |

因此，射击法与配点法的真正分歧，不在于是否"使用" PMP，而在于**如何使用** PMP。前者试图在连续层面忠实地执行 PMP，后者则通过离散化和优化理论的工具，在离散层面间接地满足 PMP。

从数学上看，这两种方法分别代表了求解最优控制问题的两条路径：

- **直接法**（direct methods）：从优化的角度出发，将问题离散化为 NLP
- **间接法**（indirect methods）：从变分的角度出发，求解连续时间的必要条件

配点法属于直接法，射击法属于间接法。但正如我们所看到的，直接法并非真的"绕过"了必要条件，而是以对偶变量的形式隐式地包含了这些条件。在这一意义上，直接法与间接法的分野，并不如表面看上去那么绝对。

## 10. 小结：协态从未消失，只是被结构性地隐藏

在最优控制理论的发展历程中，协态变量始终扮演着核心角色。从拉格朗日力学的广义动量，到哈密顿力学的正则共轭变量，再到庞特里亚金最大值原理的伴随函数，协态是连接变分结构与最优性条件的关键纽带。

然而，当我们从理论走向计算，协态似乎突然"消失"了。在配点法及其他直接优化方法中，我们不再显式地引入协态变量，不再求解伴随方程，问题被完全表达为一个关于状态和控制的有限维优化问题。这一现象长期以来引发了某种误解：直接法是否抛弃了变分原理？协态是否只是理论分析的工具，而在实际计算中可有可无？

通过本文的分析，我们已经清楚地看到：**协态从未消失**。

它只是完成了一次角色转变：从显式的主变量，转变为隐式的对偶变量；从微分方程的解,转变为代数约束的拉格朗日乘子。在配点法的 KKT 条件中，协态以对偶变量的形式被完整地保留，并且可以从 NLP 求解器返回的乘子中直接恢复。在高阶谱配点方法中，恢复出的协态具有与状态同等的精度，并在谱意义下满足连续 PMP 的伴随方程。

这一认识具有深远的意义。它表明：

1. **最优控制的数值方法并不是对理论的背离，而是理论在计算世界中的延续。** 配点法通过优化理论的工具，重现了变分法的庞特里亚金原理，只是表达形式从连续微分方程变为了离散代数方程。

2. **直接法与间接法的分野并不如表面看上去那么绝对。** 两者都植根于同一个数学结构——哈密顿系统的辛几何，只是在不同层面对这一结构进行表达和求解。

3. **协态变量虽然在配点法中不再显式出现，但它以对偶变量的形式，继续维系着最优控制问题的结构完整性。** 这种结构完整性不仅体现在理论层面，更体现在数值精度和收敛性上。

从更宏观的视角来看，最优控制理论的发展历程，实际上是一个不断寻求"结构"与"计算"之间平衡的过程。变分法揭示了问题的内在结构，但在数值层面难以直接执行；射击法忠实于变分结构，但继承了哈密顿系统的全部数值困难；配点法通过改变表达方式，在保持结构完整性的同时，实现了计算的可行性。
